name: Initialize Repository

on:
  workflow_dispatch:    # ÊâãÂä®Ëß¶ÂèëÔºåÂèØÁî®‰∫é‰ªìÂ∫ìÈ¶ñÊ¨°ÂàùÂßãÂåñ
  push:
    paths:
      - 'LICENSE'      # ÂΩì LICENSE Êñá‰ª∂ÂèëÁîüÂèòÊõ¥Êó∂Ëß¶Âèë

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤‰ª•Á°Æ‰øùÂèØ‰ª•Ê≠£Á°ÆÊèê‰∫§
          token: ${{ secrets.GITHUB_TOKEN }}  # ‰ΩøÁî®ÂÖ∑ÊúâÂÜôÂÖ•ÊùÉÈôêÁöÑtoken

      - name: Set repository variables
        run: |
          # ‰ªéÁéØÂ¢ÉÂèòÈáè GITHUB_REPOSITORY ‰∏≠ÊèêÂèñ‰ªìÂ∫ìÂêçÁß∞ÂíåÊâÄÊúâËÄÖÔºàÊ†ºÂºè‰∏∫ owner/repoÔºâ
          REPO_FULL="${GITHUB_REPOSITORY}"
          REPO_OWNER="${REPO_FULL%/*}"
          REPO_NAME="${REPO_FULL#*/}"
          # Â∞ÜÊ®™Êù†ÊõøÊç¢‰∏∫‰∏ãÂàíÁ∫ø
          UNDERSCORE_REPO_NAME=$(echo "$REPO_NAME" | tr '-' '_')
          echo "REPO_OWNER=${REPO_OWNER}" >> $GITHUB_ENV
          echo "REPO_NAME=${REPO_NAME}" >> $GITHUB_ENV
          echo "UNDERSCORE_REPO_NAME=${UNDERSCORE_REPO_NAME}" >> $GITHUB_ENV
          echo "Repository owner: $REPO_OWNER"
          echo "Repository name: $REPO_NAME"
          echo "Repository underscore name: $UNDERSCORE_REPO_NAME"

      - name: Update .github/workflows/test-load.yml
        run: |
          # ÊõøÊç¢ test-load.yml ‰∏≠ÁöÑÂÜÖÂÆπ
          sed -i.bak "s/nonebot_plugin_template/${UNDERSCORE_REPO_NAME}/g" .github/workflows/test-load.yml
          rm -f .github/workflows/test-load.yml.bak
      
      - name: Update README.md
        run: |
          # ÊõøÊç¢ README.md ‰∏≠ÁöÑÂÜÖÂÆπ
          rm -f README.md
          sed -i.bak "s/owner/${REPO_OWNER}/g" readme_template.md
          sed -i.bak "s/nonebot-plugin-template/${REPO_NAME}/g" readme_template.md
          sed -i.bak "s/nonebot_plugin_template/${UNDERSCORE_REPO_NAME}/g" readme_template.md
          mv readme_template.md README.md
          rm -f README.md.bak
          rm -f readme_template.md.bak

      - name: Update pyproject.toml
        run: |
          # ÊõøÊç¢ pyproject.toml ‰∏≠ÁöÑÂÜÖÂÆπ
          sed -i.bak "s/nonebot-plugin-template/${REPO_NAME}/g" pyproject.toml
          sed -i.bak "s/nonebot_plugin_template/${UNDERSCORE_REPO_NAME}/g" pyproject.toml
          rm -f pyproject.toml.bak

      - name: Rename plugin folder
        run: |
          if [ -d "nonebot_plugin_template" ]; then
            mv nonebot_plugin_template "${UNDERSCORE_REPO_NAME}"
            echo "Successfully renamed plugin folder to ${UNDERSCORE_REPO_NAME}"
          else
            echo "Directory nonebot_plugin_template not found."
            exit 1
          fi


      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "üéâ Initialize repository with correct naming"
          git push